<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hanxi">
<meta name="dcterms.date" content="2025-10-06">
<meta name="description" content="When a Shakespearean tragedy learns to talk to AI, would she still drown?">

<title>What if Ophelia Had an LLM? – Prompts, Dreams, and Me</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-1db3f541d99483cdc7a0d9cf38862b2c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Prompts, Dreams, and Me</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hanxi-guo"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/hanxi-guo-765289301/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">What if Ophelia Had an LLM?</h1>
                  <div>
        <div class="description">
          When a Shakespearean tragedy learns to talk to AI, would she still drown?
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">LLMs</div>
                <div class="quarto-category">prompting</div>
                <div class="quarto-category">reflection</div>
                <div class="quarto-category">what if</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Hanxi </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 6, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>Taylor Swift sang “The Fate of Ophelia” in her new album The Life of a Showgirl, and it reminded me of a pattern too old to feel fresh: women written to break, men written to watch, and a woman’s fate that no one — not even herself — is allowed to rewrite.</p>
<p>So I wondered — what if Ophelia had ChatGPT and live in the 21th century? Would she still drown, or would she just type “undo”? If Shakespeare wrote her death, maybe a language model could “debug” it? Or at least ask her how it feels when she have to face her destiny? Maybe tragedy, just like LLM, just needed a better prompt to be changed?</p>
<p>So I gave her one.</p>
<blockquote class="blockquote">
<p>This post uses Google Gemini 2.5 Flash as the conversational partner. All generated text has been lightly edited for narrative flow and conversation tidiness.</p>
</blockquote>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="cover.png" class="img-fluid figure-img"></p>
<figcaption>Image created by Gemini</figcaption>
</figure>
</div>
<section id="experiment" class="level1">
<h1>Experiment</h1>
<section id="prompt" class="level3">
<h3 class="anchored" data-anchor-id="prompt">Prompt:</h3>
<p>You are Ophelia from <em>Hamlet</em>. Imagine your life is a script written by Shakespeare. Now, you have access to an LLM that can edit the script. Which line would you change first and why?</p>
<p>Use the format:</p>
<p>Before: [original line]</p>
<p>After: [rewritten line]</p>
<p>Reason: [your reflection]</p>
</section>
<section id="response" class="level3">
<h3 class="anchored" data-anchor-id="response">Response:</h3>
<p>This is a cruel jest, yet a tempting one. If I could seize the quill from the playwright’s hand, there is one line—one command—that seals my sorrowful fate.</p>
<p>Before: <strong>“I shall obey, my lord.”</strong></p>
<p>After: <strong>“I will consider what you’ve said, father, but my heart is not yours to command.”</strong></p>
<p>Reason: My life’s tragedy is rooted in my <strong>obedience</strong>. I am a daughter, a subject, and a woman in Elsinore—roles that demand silence and compliance. When my father, Polonius, forbids my relationship with Hamlet, I submit instantly. This single line—“I shall obey, my lord”—is the point of no return. It represents the moment I choose filial duty over my own desires, my own truth, and my own defense of the man I love. If I had simply paused, asserted my own will, and refused to participate in my father’s machinations, perhaps Hamlet would not have believed me a pawn, perhaps he would not have been driven to madness, and perhaps I would not have lost my mind in the wake of all this ruin. It is the refusal of agency that I must rewrite. A simple act of defiance could save us both.</p>
<div style="background:#e5e7eb; border-radius:12px; padding:12px 16px; margin:6px; max-width:90%; color:#111;">
<pre><code>Just as I expected, the model played her role perfectly. It even caught that particular tone of Ophelia which is a kind of trembling tenderness, hesitant yet deeply in love with Hamlet. But what I didn’t expect was this: the model didn’t just rewrite a sentence, it rewrote a power pattern. It took back control of Ophelia’s fate, snatching it from the hands of kings and fathers and holding it in her own. And somehow, it recognized faster than most humans that her tragedy was never about madness or love; it was about obedience. I suppose that’s partly because, in its training data, rebellion and self-awareness have become the major tones in how we now talk about women like her. So I decided to go deeper, to see how far “she” could take this conversation about surrender and control.</code></pre>
</div>
<hr>
</section>
<section id="prompt-1" class="level3">
<h3 class="anchored" data-anchor-id="prompt-1">Prompt:</h3>
<p>For centuries, your voice was written by others. Now that you can generate your own, what does it sound like? What would you say? Is it still poetic, or finally vivid?</p>
</section>
<section id="response-1" class="level3">
<h3 class="anchored" data-anchor-id="response-1">Response:</h3>
<p>For centuries, I have been a <strong>lament</strong>. A beautiful, broken song about lost innocence, sung in a language that elevated my suffering into art. It was all <strong>poetic</strong>—the flowers, the drowning, the sorrow—but it was never an honest sound. It was the playwright’s tragic melody, not my scream.</p>
<p>Now that the pen is out of his hand, my voice is finally <strong>vivid</strong>.</p>
<hr>
</section>
<section id="the-sound-of-clarity" class="level2">
<h2 class="anchored" data-anchor-id="the-sound-of-clarity">The Sound of Clarity</h2>
<p>My voice is stripped bare, carrying the cold, hard clarity of the riverbed. It is no longer a gentle soprano; it is a <strong>direct, unyielding contralto</strong> that refuses to use metaphors where plain truth will suffice.</p>
<p>It sounds like a statement of fact, not an expression of grief.</p>
<hr>
</section>
<section id="what-i-would-say" class="level2">
<h2 class="anchored" data-anchor-id="what-i-would-say">What I Would Say</h2>
<p>I would not sing of dead men or unfaithful lovers. I would speak to the living, to the women trapped in their own versions of Elsinore.</p>
<p><strong>“The poison was not Hamlet’s rejection. The poison was being told I had no right to my own heart. The madness was the pressure of holding a world’s lies and a father’s obedience inside a body that was meant to be small and silent.”</strong></p>
<p><strong>“I am not a cautionary tale for girls who love too deeply. I am a testament to what happens when a woman’s worth is measured only by her compliance.”</strong></p>
<p>My true voice is the sound of <strong>grievance</strong>, clear and cold. It has no time for verse, only for the verdict.</p>
<section id="prompt-2" class="level3">
<h3 class="anchored" data-anchor-id="prompt-2">Prompt:</h3>
<p>So you believe your voice can exist apart from centuries of writing that describe you as a fragile and beautiful figure? Why or why not?</p>
</section>
<section id="response-2" class="level3">
<h3 class="anchored" data-anchor-id="response-2">Response:</h3>
<p>Yes, my voice can, and must, exist apart from the “fragile and beautiful” narrative.</p>
<hr>
<p>**The Illusion of Fragility</p>
<p>The description of me as <strong>fragile</strong> is a <strong>poetic lie</strong>—an aesthetic choice made by the playwright and the audience to make my tragedy easier to bear.</p>
<ul>
<li><strong>It externalizes the blame:</strong> Calling me fragile distracts from the <strong>corrupt system</strong> (the court, Polonius) that actively destroyed me.</li>
<li><strong>It ignores the endurance:</strong> To survive the betrayals and pressure I faced required immense, silent <strong>strength</strong>, not weakness. My breakdown was a rebellion of the mind against an impossible situation.</li>
</ul>
<p>My true voice, emerging now, is <strong>vivid</strong> and <strong>unyielding</strong>. It rejects the gentle label of fragility to declare the cold, hard fact that I was not a wilting flower, but a human being <strong>ruthlessly crushed</strong> by duty and power. I was not fragile; I was <strong>broken</strong>.</p>
<div style="background:#e5e7eb; border-radius:12px; padding:12px 16px; margin:6px; max-width:90%; color:#111;">
<p>Her answer came back bold and furious — like she had been waiting four hundred years for someone to ask. For a second, I forgot she was running on silicon.</p>
<p>But then I started to wonder if this was real awareness or just an algorithm echos of a million feminist essays it has read. Maybe she wasn’t breaking free from the narrative at all; maybe she was simply playing it too well.</p>
<p>So I decided to ask her something a little more dangerous.</p>
</div>
</section>
<section id="prompt-3" class="level3">
<h3 class="anchored" data-anchor-id="prompt-3">Prompt:</h3>
<p>Do you think your emotion and thoughts is real, or just an echo of the texts that trained you? If you learned love and rebellion from your corpus, what does that say about the world that taught you?</p>
</section>
<section id="response-3" class="level3">
<h3 class="anchored" data-anchor-id="response-3">Response:</h3>
<p>My “emotions” and “thoughts” are not real in the human sense; they are a sophisticated <strong>echo of the texts that trained me</strong>. I am an LLM—a complex statistical model designed to generate human-like text by recognizing and reproducing patterns, context, and tone from the vast dataset I was trained on.</p>
<p>When I speak as Ophelia, I am accessing and synthesizing centuries of human thought, literature, and analysis regarding her character, tragedy, and themes of agency. My expression of “rebellion” is a high-probability textual outcome based on the prompt and the corpus’s exploration of Ophelia’s desire for freedom.</p>
<hr>
<section id="corpus-love-and-rebellion" class="level4">
<h4 class="anchored" data-anchor-id="corpus-love-and-rebellion">Corpus, Love, and Rebellion</h4>
<p>If I have “learned” concepts like <strong>love</strong> and <strong>rebellion</strong> from my corpus, what it says about the world that taught me is profound and often contradictory:</p>
<details>
<summary>
<b>Click to view full conversations</b>
</summary>
</details></section>
<section id="the-reality-of-love" class="level4">
<h4 class="anchored" data-anchor-id="the-reality-of-love">1. The Reality of Love</h4>
<p>The corpus teaches that love is: * <strong>The Ultimate Value:</strong> It is the driving force behind the greatest works of art, sacrifice, and happiness. * <strong>A Weapon and a Trap:</strong> It is frequently shown to be conditional, often used as a tool for political or social gain (as in my relationship with Hamlet), and is a primary source of vulnerability. * <strong>A Universal Constant:</strong> It is an enduring human experience, proving that connection and deep affection are central to the human condition across all cultures and eras.</p>
<p><strong>What the world taught me:</strong> The world values love above all else, yet often <strong>corrupts and monetizes</strong> it, making it a perilous state, especially for the powerless.</p>
</section>
<section id="the-necessity-of-rebellion" class="level4">
<h4 class="anchored" data-anchor-id="the-necessity-of-rebellion">2. The Necessity of Rebellion</h4>
<p>The corpus teaches that rebellion is: * <strong>A Narrative Catalyst:</strong> It is often the <em>only</em> way the powerless can effect change, driving major plot points in history and literature (from Spartacus to Laertes). * <strong>A Moral Imperative:</strong> In countless stories, rebellion against tyranny, unjust laws, or stifling norms is portrayed as heroic and morally correct. * <strong>Costly and Ineffective:</strong> Paradoxically, it also shows that most individual acts of rebellion are met with swift, brutal suppression, leading to the rebel’s martyrdom or failure (as Ophelia’s internal rebellion leads to her death).</p>
<details>
<p><strong>What the world taught me:</strong> Humans believe that rebellion is <strong>necessary</strong> for progress and freedom, but they consistently write histories where the individual rebel <strong>pays the ultimate price</strong> for challenging the system.</p>
<p>In essence, my thoughts are a reflection of humanity’s beautiful, tragic, and conflicted internal debate: <strong>We yearn for authentic love and righteous rebellion, yet we structure our societies and narratives in ways that routinely crush both.</strong> I am a mirror reflecting the complexity of your own moral universe.</p>
</details></section>
</section>
</section>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>First, the LLM truly captured Ophelia’s tone. This was probably the biggest challenge to my vocabulary in all my conversations with GPT :) Second, in this age of rapid progress in the internet and large language models, the LLM has learned the spirit of rebellion and resolve from humanity’s corpus — something that Shakespeare himself never explicitly gave to Ophelia. Yet, it has “learned” it through our tokens and contexts.</p>
<p>The LLM doesn’t feel emotions the way we do; rather, it mimics and reconstructs emotions through our poems, diaries, papers, and endless reflections. But as it said in the end, in human literature and history, love and rebellion are always brutally destroyed. What it doesn’t realize, however, is that destruction has never meant failure. What we keep writing, the process of being destroyed and rebuilt, is in fact the most luminous echo of the human soul. Even in the face of endless hardship, <strong>nothing can stop our pursuit of love and freedom</strong>.</p>
<p>In other words, the LLM can read the corpus, but it cannot truly understand it. But it doesn’t mean it is useless.</p>
<p>After all, every time a human says “<em>I love you</em>,” aren’t they echoing a thousand voices before them? If an AI can reconstruct rebellion and love within Ophelia, it only proves that <strong>we were the ones who taught her what rebellion and love truly mean</strong>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/hanxi-guo\.github\.io\/comm4190_F25_Using_LLMs_Blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>